From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jake Potrebic <jake.m.potrebic@gmail.com>
Date: Fri, 26 May 2023 18:14:44 -0700
Subject: [PATCH] Code Generation

Currently includes generated key holder classes for types
used in the Registry Modification API

diff --git a/build.gradle.kts b/build.gradle.kts
index 97ba0ab8e268ba2f937143aaa5b68ea6f6cbfb88..debdd5ec348d42ead91f7436edce3618ad59dbec 100644
--- a/build.gradle.kts
+++ b/build.gradle.kts
@@ -1,6 +1,7 @@
 plugins {
     `java-library`
     `maven-publish`
+    idea // Paper
 }
 
 java {
@@ -43,6 +44,22 @@ dependencies {
     testImplementation("org.ow2.asm:asm-tree:9.4")
 }
 
+// Paper start
+val generatedApiPath: java.nio.file.Path = project(":paper-api-generator").projectDir.toPath().resolve("generated")
+idea {
+    module {
+        generatedSourceDirs.add(generatedApiPath.toFile())
+    }
+}
+sourceSets {
+    main {
+        java {
+            srcDir(generatedApiPath)
+        }
+    }
+}
+// Paper end
+
 configure<PublishingExtension> {
     publications.create<MavenPublication>("maven") {
         from(components["java"])
@@ -105,3 +122,15 @@ tasks.check {
     dependsOn(scanJar)
 }
 // Paper end
+// Paper start
+// TODO uncomment once paperweight is updated to include this task type
+// val scanJarForOldGeneratedCode = tasks.register("scanJarForOldGeneratedCode", io.papermc.paperweight.tasks.ScanJarForOldGeneratedCode::class) {
+//     mcVersion.set(providers.gradleProperty("mcVersion"))
+//     annotation.set("Lio/papermc/paper/generated/GeneratedFrom;")
+//     jarToScan.set(tasks.jar.flatMap { it.archiveFile })
+//     classpath.from(configurations.compileClasspath)
+// }
+// tasks.check {
+//     dependsOn(scanJarForOldGeneratedCode)
+// }
+// Paper end
diff --git a/src/main/java/io/papermc/paper/generated/GeneratedFrom.java b/src/main/java/io/papermc/paper/generated/GeneratedFrom.java
new file mode 100644
index 0000000000000000000000000000000000000000..87325f75e258717fef01ff5fee4dde7ae6fd8cd2
--- /dev/null
+++ b/src/main/java/io/papermc/paper/generated/GeneratedFrom.java
@@ -0,0 +1,20 @@
+package io.papermc.paper.generated;
+
+import java.lang.annotation.Documented;
+import java.lang.annotation.ElementType;
+import java.lang.annotation.Retention;
+import java.lang.annotation.RetentionPolicy;
+import java.lang.annotation.Target;
+import org.jetbrains.annotations.ApiStatus;
+
+/**
+ * Used to mark classes which are generated from
+ * a specific version of minecraft.
+ */
+@Documented
+@Retention(RetentionPolicy.RUNTIME)
+@Target(ElementType.TYPE)
+@interface GeneratedFrom {
+
+    String value();
+}
diff --git a/src/main/java/io/papermc/paper/registry/TypedKey.java b/src/main/java/io/papermc/paper/registry/TypedKey.java
new file mode 100644
index 0000000000000000000000000000000000000000..273a96dae8ad0fccdeec6e3f3262a18a73697fc3
--- /dev/null
+++ b/src/main/java/io/papermc/paper/registry/TypedKey.java
@@ -0,0 +1,19 @@
+package io.papermc.paper.registry;
+
+import net.kyori.adventure.key.Key;
+import net.kyori.adventure.key.Keyed;
+import org.jetbrains.annotations.ApiStatus;
+import org.jetbrains.annotations.NotNull;
+
+public interface TypedKey<T extends Keyed> extends Keyed {
+
+    @Override
+    @NotNull Key key();
+
+    // @NotNull RegistryKey<T> registryKey();
+
+    @ApiStatus.Internal
+    static <T extends Keyed> @NotNull TypedKey<T> create(@NotNull Key key/* , @NotNull RegistryKey<T> registryKey */) {
+        return new TypedKeyImpl<>(key/* , registryKey */);
+    }
+}
diff --git a/src/main/java/io/papermc/paper/registry/TypedKeyImpl.java b/src/main/java/io/papermc/paper/registry/TypedKeyImpl.java
new file mode 100644
index 0000000000000000000000000000000000000000..7a1f8fe92debceda2ca8c34c0e6cbbf777e388a0
--- /dev/null
+++ b/src/main/java/io/papermc/paper/registry/TypedKeyImpl.java
@@ -0,0 +1,8 @@
+package io.papermc.paper.registry;
+
+import net.kyori.adventure.key.Key;
+import net.kyori.adventure.key.Keyed;
+import org.jetbrains.annotations.NotNull;
+
+record TypedKeyImpl<T extends Keyed>(@NotNull Key key /*, RegistryKey<T> registryKey */) implements TypedKey<T> {
+}
diff --git a/src/main/java/org/bukkit/MinecraftExperimental.java b/src/main/java/org/bukkit/MinecraftExperimental.java
index 4e7e69219876eb6162f6e2cdf2ac3d242f7d75f6..b325b96711dd69e8fa21f6abf307994d9e72caa3 100644
--- a/src/main/java/org/bukkit/MinecraftExperimental.java
+++ b/src/main/java/org/bukkit/MinecraftExperimental.java
@@ -24,4 +24,5 @@ import org.jetbrains.annotations.ApiStatus;
 })
 @ApiStatus.Internal
 public @interface MinecraftExperimental {
+    String value() default ""; // Paper
 }
