From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Sceri <scerimail@gmail.com>
Date: Fri, 14 May 2021 19:06:51 +0500
Subject: [PATCH] Fix CraftPotionBrewer cache


diff --git a/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionBrewer.java b/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionBrewer.java
index 98f6c1c136ee86244c0a8898c0e671406d51f234..5e48b2e44451ce3630a6e34f142b5091dd1ecc78 100644
--- a/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionBrewer.java
+++ b/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionBrewer.java
@@ -17,12 +17,18 @@ import org.bukkit.potion.PotionEffectType;
 import org.bukkit.potion.PotionType;
 
 public class CraftPotionBrewer implements PotionBrewer {
-    private static final Map<PotionType, Collection<PotionEffect>> cache = Maps.newHashMap();
+    private static final Map<Integer, Collection<PotionEffect>> cache = Maps.newHashMap(); // Paper
 
     @Override
     public Collection<PotionEffect> getEffects(PotionType damage, boolean upgraded, boolean extended) {
-        if (CraftPotionBrewer.cache.containsKey(damage))
-            return CraftPotionBrewer.cache.get(damage);
+        // Paper start
+        int key = damage.ordinal() << 2;
+        key |= (upgraded ? 1 : 0) << 1;
+        key |= extended ? 1 : 0;
+
+        if (CraftPotionBrewer.cache.containsKey(key))
+            return CraftPotionBrewer.cache.get(key);
+        // Paper end
 
         List<MobEffectInstance> mcEffects = Potion.byName(CraftPotionUtil.fromBukkit(new PotionData(damage, extended, upgraded))).getEffects();
 
@@ -31,9 +37,9 @@ public class CraftPotionBrewer implements PotionBrewer {
             builder.add(CraftPotionUtil.toBukkit(CraftRegistry.getMinecraftRegistry().registryOrThrow(Registries.MOB_EFFECT), effect));
         }
 
-        CraftPotionBrewer.cache.put(damage, builder.build());
+        CraftPotionBrewer.cache.put(key, builder.build()); // Paper
 
-        return CraftPotionBrewer.cache.get(damage);
+        return CraftPotionBrewer.cache.get(key); // Paper
     }
 
     @Override
